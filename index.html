<!DOCTYPE html>
<html lang="en">
<head>
<title>Christmas SPA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<style>
body {
  margin:0;
  height:100vh;
  overflow:hidden;
  background: radial-gradient(circle, #0b0f29, #02040f);
  font-family:'Poppins',sans-serif;
  color:white;
  text-align:center;
}

/* UNIVERSAL PAGES */
.page {
  width:100%;
  height:100%;
  position:absolute;
  top:0; left:0;
  display:none;
  overflow:hidden;
}

#page1 { display:block; }

/* LOGO */
.main-logo {
  width:140px;
  margin-top:20px;
  filter:drop-shadow(0 0 10px white);
}
.text-logo {
  font-size: 28px;
  font-weight: 700;
  margin-top: 5px;
  margin-bottom: 10px;
  text-shadow:0 0 12px white;
  letter-spacing: 1px;
}

/* Stars */
.star {
  position:absolute;
  width:2px;
  height:2px;
  background:white;
  border-radius:50%;
  animation:twinkle 3s infinite alternate;
}
@keyframes twinkle {
  0% {opacity:.3; transform:scale(1);}
  100% {opacity:1; transform:scale(1.6);}
}

/* Sparkles */
.sparkle {
  position:absolute;
  width:4px;
  height:4px;
  background:yellow;
  border-radius:50%;
  box-shadow:0 0 10px yellow;
  animation:fall 5s linear;
}
@keyframes fall {
  0% {transform:translateY(-10px); opacity:1;}
  100% {transform:translateY(110vh); opacity:0;}
}

/* Ornaments */
.ornament {
  position:absolute;
  width:22px;
  height:22px;
  border-radius:50%;
  animation:float 6s infinite alternate ease-in-out;
}
@keyframes float { 
  from {transform:translateY(0);} 
  to {transform:translateY(-25px);} 
}

/* Garland */
.garland-item { position:absolute; z-index:99; }
.pine {
  width:25px; height:4px; background:#0f0; border-radius:4px;
  transform:rotate(40deg);
}
.pine2 {
  width:25px; height:4px; background:#0c0; border-radius:4px;
  transform:rotate(-40deg);
}
.leaf {
  width:0; height:0;
  border-left:12px solid transparent;
  border-right:12px solid transparent;
  border-bottom:25px solid #007f00;
  filter:drop-shadow(0 0 4px #0f0);
}
.berry {
  width:10px; height:10px; background:red;
  border-radius:50%; box-shadow:0 0 8px red;
  position:absolute;
}

/* DOOR */
.door {
  width:260px;
  height:400px;
  background:linear-gradient(#a0360f,#5c1b00);
  margin:auto;
  margin-top:30px;
  border:4px solid #360b00;
  border-radius:8px;
  box-shadow:0 0 20px #000;
  position:relative;
  cursor:pointer;
  animation:pulse 3s infinite ease-in-out;
}
@keyframes pulse {
  0%,100% {transform:scale(1);}
  50% {transform:scale(1.03);}
}
.knob {
  width:35px;
  height:35px;
  background:gold;
  border-radius:50%;
  position:absolute;
  right:35px;
  top:50%;
  transform:translateY(-50%);
  box-shadow:0 0 10px gold;
}

/* PAGE 2 */
#page2 h1 {
  font-size:45px;
  color:#00ffaa;
  margin-top:20px;
  text-shadow:0 0 20px #00ffaa;
  animation:glow 3s infinite alternate;
}
@keyframes glow {
  from {text-shadow:0 0 10px #00ffaa;}
  to   {text-shadow:0 0 35px #00ffaa;}
}

.footer-input {
  position:absolute; bottom:0; width:100%;
  background:red; padding:20px; display:flex;
  justify-content:center; gap:10px;
}
.footer-input input {
  padding:12px; border:none; border-radius:10px;
  font-size:18px; width:220px;
}
.footer-input button {
  padding:12px 25px; background:white; border:none;
  color:red; border-radius:10px; font-weight:bold; cursor:pointer;
}

/* PAGE 3 */
#page3 h1 {
  margin-top:20px;
  font-size:28px;
  color:#00ffaa;
  text-shadow:0 0 20px #00ffaa;
}

.btn {
  margin-top:20px;
  padding:12px 25px;
  border:none;
  border-radius:10px;
  font-size:18px;
  cursor:pointer;
  color:white;
}
.download { background:red; }
.share { background:green; }

.cert-box {
  margin:auto; margin-top:35px;
  background:white; color:black;
  width:280px; padding:12px;
  border-radius:8px; border:2px solid red;
  font-size:18px;
}

.footer-input {
  position:absolute; bottom:0; width:100%;
  background:red; padding:20px; display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}

.footer-input input {
  padding:12px; border:none; border-radius:10px;
  font-size:18px; width:260px;
}
</style>
</head>
<body>

<!-- AUDIO -->
<audio id="bgMusic" loop>
  <source src="https://www.dropbox.com/scl/fi/4x9xygwokyv0vyqbcvd05/deck-the-halls-christmas-440629.mp3?rlkey=csf5erhztyq5azfyf5wqxz63t&st=aukh66k4&raw=1" type="audio/mpeg">
</audio>

<!-- PAGE 1 -->
<div id="page1" class="page">
  <img class="main-logo" src="https://i.postimg.cc/RVtDrqPT/Screenshot-20251029-225004-2.png">
  <div class="text-logo">Flexi Tutors</div>

  <div class="door">
    <div class="knob"></div>
  </div>
</div>

<!-- PAGE 2 -->
<div id="page2" class="page">
  <img class="main-logo" src="https://i.postimg.cc/RVtDrqPT/Screenshot-20251029-225004-2.png">
  <div class="text-logo">Flexi Tutors</div>

  <h1>Merry Christmas</h1>

<div class="footer-input">
  <input id="username" type="text" placeholder="Enter your name">
  <input id="whatsapp" type="tel" placeholder="Enter WhatsApp number">
  <button onclick="goCert()">Go</button>
</div>
</div>

<!-- PAGE 3 -->
<div id="page3" class="page">
  <img class="main-logo" src="https://i.postimg.cc/RVtDrqPT/Screenshot-20251029-225004-2.png">
  <div class="text-logo">Flexi Tutors</div>

  <div id="countdown" style="font-size:22px; margin-top:10px; text-shadow:0 0 10px #00ffaa;"></div>

  <h1 id="greet"></h1>
  
  <button class="btn download" onclick="makePDF()">Download (PDF)</button>
  <button class="btn share" onclick="share()">Share on WhatsApp</button>

  <div class="cert-box">Brought to you by <b>Flexi Tutors</b></div>
</div>
<script>
// ---------------------------------------  
// FIREBASE CONFIGURATION  
// ---------------------------------------  
document.addEventListener("DOMContentLoaded", function () {  

const firebaseConfig = {  
  apiKey: "AIzaSyCaVTwzI_0h0RVdh_ASDDqdsvrg_3oHPSs",  
  authDomain: "flexi-702a9.firebaseapp.com",  
  projectId: "flexi-702a9",  
  storageBucket: "flexi-702a9.appspot.com",  
  messagingSenderId: "647814322831",  
  appId: "1:647814322831:web:74fc00cfc62abdc7e76efa",  
  measurementId: "G-7BC49SZJ6V"  
};

// INIT FIREBASE
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let musicStarted = false;

// GET ELEMENTS
const page1 = document.getElementById("page1");
const page2 = document.getElementById("page2");
const page3 = document.getElementById("page3");
const username = document.getElementById("username");
const greet = document.getElementById("greet");
const countdown = document.getElementById("countdown");
const bgMusic = document.getElementById("bgMusic");

// FIX DOOR CLICK
document.querySelector(".door").onclick = () => {
  page1.style.display = "none";
  page2.style.display = "block";
  decorations(page2);
};

// ---------------------------------------
// AUTO VERIFICATION MODE (?id=XXXXX)
// ---------------------------------------
const params = new URLSearchParams(window.location.search);
const verifyID = params.get("id");

if (verifyID) runVerification(verifyID);

// ---------------------------------------
// MUSIC
// ---------------------------------------
document.body.addEventListener("click", () => {
  if (!musicStarted) {
    bgMusic.play();
    musicStarted = true;
  }
}, { once: true });

// ---------------------------------------
// PAGE NAVIGATION
// ---------------------------------------
function goCert() {

  let n = username.value.trim();
  let w = whatsapp.value.trim();

  if (!n) return alert("Enter your name");
  if (!w) return alert("Enter your WhatsApp number");

  page2.style.display = "none";
  page3.style.display = "block";

  greet.innerHTML = `Dear ${n}, Flexi Tutors wishes you a Merry Christmas.`;

  decorations(page3);

  generateCertificate(n, w); // correct
}


// ---------------------------------------
// DECORATIONS
// ---------------------------------------
function decorations(container) {
  for (let i = 0; i < 70; i++) {
    let s = document.createElement("div");
    s.className = "star";
    s.style.left = Math.random() * 100 + "vw";
    s.style.top = Math.random() * 100 + "vh";
    container.appendChild(s);
  }

  setInterval(() => {
    let sp = document.createElement("div");
    sp.className = "sparkle";
    sp.style.left = Math.random() * 100 + "vw";
    container.appendChild(sp);
    setTimeout(() => sp.remove(), 5000);
  }, 250);

  let colors = ["red", "gold", "blue", "green", "pink"];
  for (let i = 0; i < 12; i++) {
    let o = document.createElement("div");
    o.className = "ornament";
    let c = colors[Math.floor(Math.random() * colors.length)];
    o.style.background = c;
    o.style.boxShadow = `0 0 15px ${c}`;
    o.style.left = Math.random() * 100 + "vw";
    o.style.top = Math.random() * 80 + "vh";
    container.appendChild(o);
  }
}

function placeGarland(parent, x, y) {
  let g = document.createElement("div");
  g.className = "garland-item";
  g.style.left = x + "px";
  g.style.top = y + "px";

  g.innerHTML = `
    <div class="pine"></div>
    <div class="pine2" style="margin-top:-4px"></div>
    <div class="leaf" style="margin-top:3px"></div>
    <div class="berry" style="left:10px; top:20px"></div>
  `;

  parent.appendChild(g);
}

// ---------------------------------------
// IMAGE LOADER
// ---------------------------------------
function loadImage(url) {
  return new Promise(resolve => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.src = url;
  });
}

// ---------------------------------------
// GENERATE CERTIFICATE PROCESS
// ---------------------------------------
function generateCertificate(name, whatsapp) {
  const certID =
    "CERT-" + Date.now() + "-" + Math.floor(1000 + Math.random() * 9000);

  createQR(certID).then(() => {
  saveCertificate(name, whatsapp, certID);
  makePDF(name, certID);
});

  setTimeout(() => {
  makePDF(name, certID);
  }, 800);
}

// ---------------------------------------
// CREATE QR CODE
// ---------------------------------------
function createQR(certID) {
  return new Promise(resolve => {
    const qrCanvas = document.createElement("canvas");

    new QRious({
      element: qrCanvas,
      value: "https://flexi-programmers.github.io/surprise/?id=" + certID,
      size: 180,
      level: "H",
    });

    document.qrImage = qrCanvas;

    // Wait for QRious to finish drawing
    setTimeout(() => resolve(), 200);
  });
}

// ---------------------------------------
// SAVE CERTIFICATE — FIRESTORE FIXED
// ---------------------------------------
function saveCertificate(name, whatsapp, certID) {

  // Remove spaces and non-digits (except +)
  whatsapp = whatsapp.trim();
  whatsapp = whatsapp.replace(/[^0-9+]/g, "");

  if (!whatsapp.startsWith("+234")) {
    if (whatsapp.startsWith("+")) whatsapp = whatsapp.substring(1);
    if (whatsapp.startsWith("0")) whatsapp = whatsapp.substring(1);
    whatsapp = "+234" + whatsapp;
  }

  db.collection("certificates")
    .doc(certID)
    .set({
      id: certID,
      name,
      whatsapp,
      timestamp: new Date().toISOString(),
      verificationURL:
        "https://flexi-programmers.github.io/surprise/?id=" + certID,
      status: "valid",
    })
    .then(() => console.log("Saved to Firestore"))
    .catch(err => console.error("Firestore error:", err));
}

// ---------------------------------------
// PDF GENERATOR (UNCHANGED)
// ---------------------------------------
function makePDF(name, certID) {
const { jsPDF } = window.jspdf;
const pdf = new jsPDF("p", "pt", "a4");

const green = "#0a8a0a";
const red = "#c40000";
const gold = "#d4af37";

const logoURL =
"https://i.postimg.cc/RVtDrqPT/Screenshot-20251029-225004-2.png";
const sigURL =
"https://i.postimg.cc/8z2rWfGC/Screenshot-20251126-082352-2.jpg";

Promise.all([loadImage(logoURL), loadImage(sigURL)]).then(
([logo, sigImg]) => {
const pageWidth = pdf.internal.pageSize.getWidth();
const pageHeight = pdf.internal.pageSize.getHeight();

// Watermark  
  pdf.saveGraphicsState();  
  pdf.setGState(new pdf.GState({ opacity: 0.08 }));  
  pdf.setFontSize(120);  
  pdf.setTextColor(150);  
  pdf.text("FLEXI TUTORS", pageWidth / 2, pageHeight / 2, {  
    align: "center",  
    angle: 35,  
  });  
  pdf.restoreGraphicsState();  

  // Borders  
  pdf.setDrawColor(red);  
  pdf.setLineWidth(6);  
  pdf.rect(30, 30, 535, 785);  

  pdf.setDrawColor(green);  
  pdf.setLineWidth(3);  
  pdf.rect(45, 45, 505, 755);  

  pdf.setDrawColor(gold);  
  pdf.setLineWidth(2);  
  pdf.rect(60, 60, 475, 725);  

  let cursorY = 110;  

  // Logo  
  pdf.addImage(logo, "PNG", 225, cursorY, 150, 150);  
  cursorY += 170;  

  // Header  
  pdf.setFillColor(red);  
  pdf.rect(60, cursorY - 25, 475, 55, "F");  

  pdf.setTextColor("white");  
  pdf.setFont("helvetica", "bold");  
  pdf.setFontSize(22);  
  pdf.text("FLEXI TUTORS CHRISTMAS CERTIFICATE", 300, cursorY + 8, {  
    align: "center",  
  });  

  cursorY += 80;  

  // Body text  
  pdf.setFontSize(17);  
  pdf.setTextColor("#000");  
  pdf.text("This certifies that", 300, cursorY, { align: "center" });  
  cursorY += 38;  

  pdf.setFont("helvetica", "bold");  
  pdf.setFontSize(32);  
  pdf.setTextColor(green);  
  pdf.text(name, 300, cursorY, { align: "center" });  
  cursorY += 50;  

  pdf.setFont("helvetica", "normal");  
  pdf.setFontSize(17);  
  pdf.setTextColor("#000");  
  pdf.text("from Flexi Tutors has been active.", 300, cursorY, {  
    align: "center",  
  });  

  cursorY += 30;  

  pdf.text(  
    "Submit this certificate to the admin of the WhatsApp study group.",  
    300,  
    cursorY,  
    { align: "center" }  
  );  

  cursorY += 50;  

  // Line  
  pdf.setDrawColor(gold);  
  pdf.line(150, cursorY, 450, cursorY);  

  cursorY += 35;  

  // Signature  
  pdf.addImage(sigImg, "PNG", 180, cursorY, 220, 60);  
  cursorY += 70;  

  // Signature line  
  pdf.setDrawColor("#000");  
  pdf.line(150, cursorY, 450, cursorY);  
  cursorY += 20;  

  pdf.setFontSize(14);  
  pdf.text("CEO, FLEXI SYSTEMS", 300, cursorY, { align: "center" });  

  cursorY += 45;  

  pdf.setFont("helvetica", "bold");  
  pdf.setFontSize(20);  
  pdf.setTextColor(red);  
  pdf.text("Merry Christmas", 300, cursorY, { align: "center" });  
if (!document.qrImage) {
  alert("QR not generated yet — retry.");
  return;
}
  // QR  
  const qrData = document.qrImage.toDataURL("image/png");  
  pdf.addImage(qrData, "PNG", pageWidth - 200, pageHeight - 250, 150, 150);  

  // Certificate ID  
  pdf.setFontSize(12);  
  pdf.setTextColor("#000");  
  pdf.text("Certificate ID: " + certID, 40, pageHeight - 40);  

  pdf.save(`FlexiTutors_Certificate_${name}.pdf`);  
}

);
}
// ---------------------------------------
// WHATSAPP SHARE
// ---------------------------------------
function share() {
  let n = username.value || "Someone";
  let msg = `${n} is wishing you a Merry Christmas!`;

  window.open(
    `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`,
    "_blank"
  );
}

// ---------------------------------------
// VERIFICATION PAGE
// ---------------------------------------
function runVerification(id) {

  page1.style.display = "none";
  page2.style.display = "none";
  page3.style.display = "block";

  greet.innerHTML = "Verifying certificate...";

  db.collection("certificates")
    .doc(id)
    .get()
    .then(doc => {
      if (!doc.exists) {
        greet.innerHTML = "<b style='color:red;'>❌ INVALID CERTIFICATE ID</b>";
        return;
      }

      let data = doc.data();

      greet.innerHTML = `
        <h2 style="color:green;">✔ Certificate Verified</h2><br>
        <b>Name:</b> ${data.name}<br>
        <b>ID:</b> ${data.id}<br>
        <b>Status:</b> ${data.status}<br>
        <b>Issued:</b> ${new Date(data.timestamp).toDateString()}<br><br>
        This certificate is valid and issued by Flexi Tutors.
      `;
    });
}

// COUNTDOWN
function startCountdown() {
  const target = new Date("December 25, 2025 00:00:00");

  setInterval(() => {
    let nowStr = new Date().toLocaleString("en-US", {
      timeZone: "Africa/Lagos",
    });

    let now = new Date(nowStr);
    let diff = target - now;

    if (diff <= 0) {
      countdown.innerHTML = "It is Christmas!";
      return;
    }

    let d = Math.floor(diff / (1000 * 60 * 60 * 24));
    let h = Math.floor((diff / (1000 * 60 * 60)) % 24);
    let m = Math.floor((diff / (1000 * 60)) % 60);
    let s = Math.floor((diff / 1000) % 60);

    countdown.innerHTML = `Countdown: <b>${d}</b>d : <b>${h}</b>h : <b>${m}</b>m : <b>${s}</b>s`;
  }, 1000);
}

startCountdown();

// Make functions global
window.goCert = goCert;
window.makePDF = makePDF;
window.share = share;

});
</script>
</body>
</html>